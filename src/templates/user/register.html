{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title|default:"Регистрация" }}</title>
  <link rel="stylesheet" href="{% static 'first_app/css/common.css' %}">
  <style>
      body {
          display: flex;
          align-items: center;
          justify-content: center;
          background-color: var(--bg-app);
      }
      .auth-card {
          width: 100%;
          max-width: 400px;
          background-color: var(--bg-surface);
          border: 1px solid var(--border-subtle);
          border-radius: var(--radius-lg);
          padding: var(--space-32);
          box-shadow: var(--shadow-lg);
      }
      .brand {
          display: flex;
          align-items: center;
          gap: var(--space-12);
          margin-bottom: var(--space-24);
          justify-content: center;
      }
      .logo {
          width: 40px;
          height: 40px;
          border-radius: var(--radius-md);
          background: linear-gradient(135deg, var(--accent-primary), var(--accent-success));
      }
      h1 {
          font-size: var(--text-lg);
          font-weight: 600;
          color: var(--text-primary);
      }
      .subtitle {
          color: var(--text-secondary);
          font-size: var(--text-sm);
          text-align: center;
          margin-bottom: var(--space-24);
      }
      .field {
          margin-bottom: var(--space-16);
      }
      label {
          display: block;
          font-size: var(--text-xs);
          color: var(--text-secondary);
          margin-bottom: var(--space-4);
          font-weight: 500;
      }
      .alert {
          background-color: rgba(248, 81, 73, 0.1);
          border: 1px solid rgba(248, 81, 73, 0.4);
          color: var(--accent-danger);
          padding: var(--space-12);
          border-radius: var(--radius-md);
          font-size: var(--text-sm);
          margin-bottom: var(--space-16);
          display: none;
      }
      .alert.show { display: block; }
      .link-row {
          margin-top: var(--space-24);
          text-align: center;
          font-size: var(--text-sm);
          color: var(--text-secondary);
      }
      .link-row a {
          color: var(--accent-primary);
          text-decoration: none;
      }
      .link-row a:hover {
          text-decoration: underline;
      }
      .social-auth {
          margin-top: var(--space-24);
      }
      .divider {
          display: flex;
          align-items: center;
          text-align: center;
          color: var(--text-secondary);
          font-size: var(--text-sm);
          margin-bottom: var(--space-16);
      }
      .divider::before,
      .divider::after {
          content: '';
          flex: 1;
          border-bottom: 1px solid var(--border-subtle);
      }
      .divider span {
          padding: 0 var(--space-12);
      }
      .social-buttons {
          display: flex;
          gap: var(--space-12);
          flex-direction: column;
      }
      .btn-social {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: var(--space-12);
          width: 100%;
          padding: var(--space-12);
          border-radius: var(--radius-md);
          font-weight: 500;
          text-decoration: none;
          transition: background-color 0.2s;
          border: 1px solid var(--border-subtle);
          background-color: var(--bg-surface);
          color: var(--text-primary);
      }
      .btn-social:hover {
          background-color: var(--bg-app);
          text-decoration: none;
      }
      .btn-vk {
          background-color: #0077FF;
          color: white;
          border-color: #0077FF;
      }
      .btn-vk:hover {
          background-color: #0066DD;
      }
      .btn-google {
          background-color: white;
          color: #3c4043;
      }
      .btn-google:hover {
          background-color: #f8f9fa;
      }
  </style>
</head>
<body>

  <div class="auth-card" id="card">
      <div class="brand">
          <div class="logo"></div>
          <h1>Time Shape</h1>
      </div>
      
      <p class="subtitle">Создайте новый аккаунт</p>

      <div class="alert" id="alert"></div>

      <form id="registerForm" novalidate>
          {% csrf_token %}
          <div class="field">
              <label for="username">Имя пользователя</label>
              <input id="username" type="text" autocomplete="username" required placeholder="username">
          </div>
          <div class="field">
              <label for="password">Пароль</label>
              <input id="password" type="password" autocomplete="new-password" required placeholder="••••••••">
          </div>
          <div class="field">
              <label for="password2">Повторите пароль</label>
              <input id="password2" type="password" autocomplete="new-password" required placeholder="••••••••">
          </div>
          <button class="btn btn-primary" id="submitBtn" type="button" style="width: 100%;">Зарегистрироваться</button>
      </form>

      <div class="link-row">
          Уже есть аккаунт? <a href="/login/">Войти</a>
      </div>
  </div>

  <script>
  (function () {
    const btn = document.getElementById('submitBtn');
    const alertBox = document.getElementById('alert');
    const user = document.getElementById('username');
    const pwd = document.getElementById('password');
    const pwd2 = document.getElementById('password2');

    function showError(text) {
      alertBox.textContent = text;
      alertBox.classList.add('show');
    }

    function setLoading(v) {
      btn.disabled = v;
      btn.textContent = v ? 'Создание...' : 'Зарегистрироваться';
    }

    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }

    btn.addEventListener('click', async () => {
      const username = user.value.trim();
      const password = pwd.value;
      const password2 = pwd2.value;

      if (!username || !password || !password2) {
        showError('Заполните все поля.');
        return;
      }
      if (password !== password2) {
        showError('Пароли не совпадают.');
        return;
      }

      alertBox.classList.remove('show');
      setLoading(true);

      try {
        const res = await fetch('/register/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({ username, password, password2 }),
        });

        if (res.status === 204) {
          window.location.href = '/';
          return;
        }

        if (res.status === 400) {
          const data = await res.json();
          showError(data.detail || 'Ошибка регистрации.');
          return;
        }
        showError('Неожиданный ответ сервера.');
      } catch {
        showError('Сервер недоступен.');
      } finally {
        setLoading(false);
      }
    });
  })();
  </script>
</body>
</html>
