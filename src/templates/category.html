{% extends 'index.html' %}

{% block links_block %}
    <link rel="stylesheet" href="../static/first_app/css/index.css">
{% endblock %}

{% block content %}
     <style>
         .edit-btn {
             position: absolute;
             top: 10px;
             right: 10px;
             width: 30px;
             height: 30px;
             border-radius: 50%;
             background: rgba(255, 255, 255, 0.2);
             display: flex;
             align-items: center;
             justify-content: center;
             transition: all 0.3s ease;
             opacity: 0;
             cursor: pointer;
             z-index: 10;
         }
         .block:hover .edit-btn {
             opacity: 1;
         }
         .edit-btn:hover {
             background: rgba(255, 255, 255, 0.4);
             transform: scale(1.1);
         }
         .edit-btn svg {
             width: 16px;
             height: 16px;
             stroke: white;
         }
     </style>

     <div class="right_panel glass-block" id="category-container">
         <div class="block glass-block" id="add-category-btn" style="cursor: pointer;">
             <h2>+</h2>
         </div>
     </div>

     <!-- Modal -->
     <div class="modal-overlay" id="create-modal">
         <div class="glass-block modal-content">
             <h2 class="modal-title" id="modal-title">Новая категория</h2>
             <input type="text" id="category-name" class="modal-input-custom" placeholder="Название...">
             <div class="modal-buttons">
                 <button class="modal-btn cancel-btn" onclick="closeModal()">Отмена</button>
                 <button class="modal-btn save-btn" id="modal-save-btn" onclick="saveCategory()">Создать</button>
             </div>
         </div>
     </div>

    <script type="text/javascript">
        const container = document.querySelector('#category-container');
        const modal = document.getElementById('create-modal');
        const addBtn = document.getElementById('add-category-btn');
        const nameInput = document.getElementById('category-name');
        const modalTitle = document.getElementById('modal-title');
        const modalSaveBtn = document.getElementById('modal-save-btn');

        let isEditing = false;
        let editingId = null;

        // Open Create Modal
        addBtn.addEventListener('click', () => {
            openCreateModal();
        });

        function openCreateModal() {
            isEditing = false;
            editingId = null;
            modalTitle.innerText = 'Новая категория';
            modalSaveBtn.innerText = 'Создать';
            nameInput.value = '';
            modal.style.display = 'flex';
            nameInput.focus();
        }

        function openEditModal(id, name) {
            isEditing = true;
            editingId = id;
            modalTitle.innerText = 'Редактировать категорию';
            modalSaveBtn.innerText = 'Сохранить';
            nameInput.value = name;
            modal.style.display = 'flex';
            nameInput.focus();
        }

        // Close Modal
        function closeModal() {
            modal.style.display = 'none';
            nameInput.value = '';
            isEditing = false;
            editingId = null;
        }

        // Close on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Save Category (Create or Update)
        function saveCategory() {
            if (isEditing) {
                updateCategory();
            } else {
                createCategory();
            }
        }

        // Create Category
        function createCategory() {
            const name = nameInput.value;
            if (!name) return;

            request({
                url: '/category/create/',
                method: 'POST',
                body: { name: name }
            }).then(data => {
                addCategoryToDOM(data);
                closeModal();
            });
        }

        // Update Category
        function updateCategory() {
            const name = nameInput.value;
            if (!name) return;
            if (!editingId) return;

            request({
                url: `/category/update/${editingId}/`,
                method: 'PATCH',
                body: { name: name }
            }).then(data => {
                // Update DOM
                const block = document.querySelector(`.block[data-id='${editingId}']`);
                if (block) {
                    const title = block.querySelector('h1.button_text');
                    if (title) title.innerText = data.name;
                }
                closeModal();
            });
        }

        function handleEdit(e, id) {
            e.stopPropagation();
            const block = document.querySelector(`.block[data-id='${id}']`);
            if (block) {
                const name = block.querySelector('h1').innerText;
                openEditModal(id, name);
            }
        }

        // Add to DOM
        function addCategoryToDOM(category) {
            const html = `
                <div class="block glass-block" data-id='${category.id}' style="cursor: pointer; position: relative;">
                    <h1 class="button_text">${category.name}</h1>
                    <div class="edit-btn" onclick="handleEdit(event, '${category.id}')" title="Редактировать">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                </div>
            `;
            addBtn.insertAdjacentHTML('beforebegin', html);
        }

        // Load Categories
        request({
            url: 'category/list/',
        }).then(data => {
            console.log(data);
            data.forEach(cat => {
                addCategoryToDOM(cat);
            });
        })

        container.addEventListener('click', (e) => {
            if (e.target.closest('.edit-btn')) return;

            const block = e.target.closest('.block[data-id]');
            if (!block) return;
            if (block.id === 'add-category-btn') return;
            const id = block.dataset.id;
            if (!id) return;
            window.location.href = `/canban/?category_id=${encodeURIComponent(id)}`;
        });
    </script>
{% endblock %}
